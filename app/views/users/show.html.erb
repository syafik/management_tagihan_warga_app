<div class="max-w-4xl mx-auto"<%= current_user.role == 1 && current_user == @user ? ' data-controller="invite-modal"'.html_safe : '' %>>
  <div class="bg-white overflow-hidden shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="sm:flex sm:items-center sm:justify-between">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Detail Pengguna</h1>
          <p class="mt-1 text-sm text-gray-500">Informasi lengkap pengguna sistem</p>
        </div>
      </div>
    </div>
    
    <div class="p-6">
      <div class="space-y-6">
        <!-- User basic info -->
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center mb-4">
            <div class="flex-shrink-0 h-12 w-12">
              <% if @user.avatar.present? %>
                <%= image_tag(@user.avatar, class: "h-12 w-12 rounded-full object-cover") %>
              <% else %>
                <div class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center">
                  <span class="text-indigo-600 font-medium text-lg"><%= @user.name.present? ? @user.name.first.upcase : 'U' %></span>
                </div>
              <% end %>
            </div>
            <div class="ml-4">
              <h2 class="text-lg font-medium text-gray-900"><%= @user.name %></h2>
              <p class="text-sm text-gray-500"><%= @user.email %></p>
            </div>
          </div>
        </div>

        <!-- User details grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <dt class="text-sm font-medium text-gray-500 mb-1">ID Pengguna</dt>
            <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2">#<%= @user.id %></dd>
          </div>
          
          <div>
            <dt class="text-sm font-medium text-gray-500 mb-1">Email</dt>
            <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2"><%= @user.email %></dd>
          </div>

          <div>
            <dt class="text-sm font-medium text-gray-500 mb-1">Nama Lengkap</dt>
            <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2"><%= @user.name %></dd>
          </div>

          <div>
            <dt class="text-sm font-medium text-gray-500 mb-1">Blok Rumah</dt>
            <dd class="text-sm text-gray-900">
              <% if @user.addresses.any? %>
                <div class="flex flex-wrap gap-2">
                  <% @user.addresses.each do |address| %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      <%= address.block_address.upcase %>
                      <% if address == @user.primary_address %>
                        <span class="ml-1 text-xs text-blue-600">(Utama)</span>
                      <% end %>
                    </span>
                  <% end %>
                </div>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">
                  Tidak ada
                </span>
              <% end %>
            </dd>
          </div>

          <% if current_user.role != 1 %>
            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">No. Telepon</dt>
              <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2">
                <%= @user.phone_number.present? ? @user.phone_number : "-" %>
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">Iuran Bulanan</dt>
              <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2">
                <%= @user.address&.contribution.present? ? number_to_currency(@user.address.contribution, unit: "Rp.", separator: ",", delimiter: ".") : "-" %>
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">Tunggakan</dt>
              <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2">
                <%= @user.address&.arrears.present? ? @user.address.arrears : "-" %>
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500 mb-1">PIC Blok</dt>
              <dd class="text-sm text-gray-900 bg-gray-50 rounded px-3 py-2">
                <%= @user.pic_blok.present? ? @user.pic_blok : "-" %>
              </dd>
            </div>
          <% end %>
        </div>

        <% if current_user.role == 1 && current_user == @user %>
          <!-- Family Members Section for Warga -->
          <div class="bg-blue-50 rounded-lg p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium text-blue-900">Anggota Keluarga</h3>
              <button type="button" 
                      class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" 
                      data-action="click->invite-modal#show">
                <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Undang Anggota Keluarga
              </button>
            </div>
            
            <div class="space-y-3">
              <% family_members = User.joins(:user_addresses).where(user_addresses: { address_id: @user.user_addresses.first&.address_id }) %>
              <% if family_members.exists? %>
                <% family_members.each do |member| %>
                  <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-8 w-8">
                        <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                          <span class="text-blue-600 font-medium text-sm"><%= member.name.present? ? member.name.first.upcase : 'A' %></span>
                        </div>
                      </div>
                      <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900"><%= member.name || member.phone_number %></p>
                        <p class="text-xs text-gray-500">
                          <%= member == @user ? "Kepala Keluarga" : "Anggota Keluarga" %>
                        </p>
                      </div>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Aktif
                    </span>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center py-6">
                  <svg class="mx-auto h-12 w-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                  <h3 class="mt-2 text-sm font-medium text-blue-900">Belum ada anggota keluarga</h3>
                  <p class="mt-1 text-sm text-blue-600">Mulai undang anggota keluarga untuk bergabung</p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-gray-200">
          <% if (current_user.role == 2) || (current_user.role == 1 && current_user == @user) %>
            <%= link_to edit_user_path(@user), class: 'inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500' do %>
              <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              <%= current_user.role == 1 ? "Edit Profile" : "Edit Pengguna" %>
            <% end %>
          <% end %>
          
          <%= link_to users_path, class: 'inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500' do %>
            <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Kembali
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <% if current_user.role == 1 && current_user == @user %>
    <!-- Invite Family Member Modal -->
    <div data-invite-modal-target="modal"
         data-action="click->invite-modal#hideOnBackdrop"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" 
         style="z-index: 9999;">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Undang Anggota Keluarga</h3>
            <button type="button" 
                    class="text-gray-400 hover:text-gray-600"
                    data-action="click->invite-modal#hide">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <%= form_with url: users_path, method: :post, local: true, class: "space-y-4", data: { invite_modal_target: "form" } do |f| %>
            <%= hidden_field_tag :invite_family_member, true %>
            <%= hidden_field_tag :primary_address_id, @user.primary_address&.id || @user.addresses.first&.id %>
            <div>
              <%= f.label :phone_number, "Nomor Telepon", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :phone_number, 
                              class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", 
                              placeholder: "Masukkan nomor telepon anggota keluarga",
                              required: true %>
              <p class="mt-1 text-xs text-gray-500">Anggota keluarga akan menerima kode login untuk bergabung</p>
            </div>
            
            <div>
              <%= f.label :name, "Nama (Opsional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :name, 
                              class: "w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm", 
                              placeholder: "Nama anggota keluarga" %>
            </div>

            <div class="flex gap-3 pt-4">
              <%= f.submit "Kirim Undangan", 
                          class: "flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
              <button type="button" 
                      data-action="click->invite-modal#hide"
                      class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Batal
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

