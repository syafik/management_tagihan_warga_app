<div class="flex flex-col gap-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Laporan Pembayaran Warga</h1>
      <p class="text-sm text-gray-500">Filter bulan berdasarkan tanggal bayar (pay_at)</p>
    </div>
  </div>

  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4">
    <%= form_with url: payment_reports_path, method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-5 gap-4" do |form| %>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
        <%= form.select :month, options_for_select((1..12).map { |m| [I18n.t('date.month_names')[m] || Date::MONTHNAMES[m], m] }, @selected_month), {}, class: "w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
        <%= form.select :year, options_for_select(((Date.current.year - 2)..(Date.current.year + 1)).to_a, @selected_year), {}, class: "w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Blok</label>
        <%= form.select :block, options_for_select([['Semua', '']] + @blocks.map { |b| ["Blok #{b}", b] }, @selected_block), {}, class: "w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">PIC</label>
        <%= form.select :pic_id, options_for_select([['Semua', '']] + @pics.map { |pic| [pic.name, pic.id] }, @selected_pic_id), {}, class: "w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div class="flex items-end">
        <%= form.submit 'Terapkan Filter', class: 'inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 w-full md:w-auto justify-center' %>
      </div>
    <% end %>
  </div>

  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
    <% if @rows.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Alamat</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Pemilik</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Bayar Bulan</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment Type</th>
              <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Total Bayar</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <% @rows.each do |row| %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900"><%= row[:address_label] %></td>
                <td class="px-4 py-3 text-sm text-gray-700"><%= row[:owner] %></td>
                <td class="px-4 py-3 text-sm text-gray-700"><%= row[:months_paid].presence || '-' %></td>
                <td class="px-4 py-3 text-sm text-gray-700"><%= row[:payment_types].presence || '-' %></td>
                <td class="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                  <% if row[:total].positive? %>
                    <%= number_to_currency(row[:total], unit: 'Rp ', precision: 0, delimiter: '.') %>
                  <% else %>
                    -
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="p-4 text-sm text-gray-600">Tidak ada data untuk filter yang dipilih.</div>
    <% end %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <% @totals_by_block.sort.each do |block, totals| %>
      <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 space-y-2">
        <div class="text-sm font-semibold text-gray-900">Blok <%= block %></div>
        <div class="flex justify-between text-sm text-gray-700"><span>Cash</span><strong><%= number_to_currency(totals[:cash], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
        <div class="flex justify-between text-sm text-gray-700"><span>Transfer</span><strong><%= number_to_currency(totals[:transfer], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
        <div class="flex justify-between text-sm text-gray-700"><span>QRIS</span><strong><%= number_to_currency(totals[:qris], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
        <div class="flex justify-between text-sm text-gray-900 border-t border-gray-100 pt-2"><span>Total Blok</span><strong><%= number_to_currency(totals[:total], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
      </div>
    <% end %>

    <div class="bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm p-4 space-y-2 md:col-span-1">
      <div class="text-sm font-semibold text-indigo-900">Total Semua Blok</div>
      <div class="flex justify-between text-sm text-indigo-900"><span>Cash</span><strong><%= number_to_currency(@overall_totals[:cash], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
      <div class="flex justify-between text-sm text-indigo-900"><span>Transfer</span><strong><%= number_to_currency(@overall_totals[:transfer], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
      <div class="flex justify-between text-sm text-indigo-900"><span>QRIS</span><strong><%= number_to_currency(@overall_totals[:qris], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
      <div class="flex justify-between text-sm text-indigo-900 border-t border-indigo-200 pt-2"><span>Total Keseluruhan</span><strong><%= number_to_currency(@overall_totals[:total], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
    </div>
  </div>
</div>
