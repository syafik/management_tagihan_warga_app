<div class="flex flex-col gap-4 sm:gap-6">
  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between sm:gap-4">
    <div>
      <p class="text-xs font-semibold uppercase tracking-wider text-indigo-600">Laporan</p>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Laporan Pembayaran Warga</h1>
      <p class="text-sm text-gray-500">Filter bulan berdasarkan tanggal bayar (pay_at).</p>
    </div>
  </div>

  <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4 sm:p-5">
    <%= form_with url: payment_reports_path, method: :get, local: true, class: "grid grid-cols-2 lg:grid-cols-6 gap-3 sm:gap-4" do |form| %>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Bulan</label>
        <%= form.select :month, options_for_select((1..12).map { |m| [I18n.t('date.month_names')[m] || Date::MONTHNAMES[m], m] }, @selected_month), {}, class: "w-full rounded-xl border-gray-200 bg-white text-sm text-gray-900 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Tahun</label>
        <%= form.select :year, options_for_select(((Date.current.year - 2)..(Date.current.year + 1)).to_a, @selected_year), {}, class: "w-full rounded-xl border-gray-200 bg-white text-sm text-gray-900 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Blok</label>
        <%= form.select :block, options_for_select([['Semua', '']] + @blocks.map { |b| ["Blok #{b}", b] }, @selected_block), {}, class: "w-full rounded-xl border-gray-200 bg-white text-sm text-gray-900 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">PIC</label>
        <%= form.select :pic_id, options_for_select([['Semua', '']] + @pics.map { |pic| [pic.name, pic.id] }, @selected_pic_id), {}, class: "w-full rounded-xl border-gray-200 bg-white text-sm text-gray-900 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div>
        <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Payment Method</label>
        <%= form.select :payment_type, options_for_select([['Semua', '']] + UserContribution::PAYMENT_TYPES.map { |label, value| [label.titleize, value] }, @selected_payment_type), {}, class: "w-full rounded-xl border-gray-200 bg-white text-sm text-gray-900 focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div class="flex items-end col-span-2 lg:col-span-1">
        <%= form.submit 'Terapkan Filter', class: 'inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 w-full lg:w-auto' %>
      </div>
    <% end %>
  </div>

  <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-3 sm:p-5">
      <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Iuran Warga</div>
      <div class="mt-2 text-lg sm:text-2xl font-semibold text-gray-900"><%= number_to_currency(@overall_totals[:total], unit: 'Rp ', precision: 0, delimiter: '.') %></div>
      <div class="mt-1.5 text-[11px] sm:text-xs text-gray-500">Total pemasukan iuran warga sesuai filter.</div>
    </div>
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-3 sm:p-5">
      <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Pemasukan Lain</div>
      <div class="mt-2 text-lg sm:text-2xl font-semibold text-emerald-700"><%= number_to_currency(@total_income_cash, unit: 'Rp ', precision: 0, delimiter: '.') %></div>
      <div class="mt-1.5 text-[11px] sm:text-xs text-gray-500">Transaksi debit selain Iuran Warga.</div>
    </div>
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-3 sm:p-5">
      <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Pengeluaran</div>
      <div class="mt-2 text-lg sm:text-2xl font-semibold text-rose-700"><%= number_to_currency(@total_expenses, unit: 'Rp ', precision: 0, delimiter: '.') %></div>
      <div class="mt-1.5 text-[11px] sm:text-xs text-gray-500">Semua transaksi kredit pada bulan ini.</div>
    </div>
  </div>

  <div class="bg-gradient-to-r from-indigo-50 via-white to-indigo-50 border border-indigo-200 rounded-2xl shadow-sm p-3 sm:p-5 col-span-2 lg:col-span-3">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="text-sm font-semibold text-indigo-900">Sisa Bulan Ini</div>
      <div class="text-lg sm:text-xl font-semibold text-indigo-900"><%= number_to_currency(@net_balance, unit: 'Rp ', precision: 0, delimiter: '.') %></div>
    </div>
    <div class="mt-1.5 text-[11px] sm:text-xs text-indigo-700">Sisa = iuran warga + pemasukan lain - pengeluaran.</div>
  </div>

  <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-2 sm:p-3">
    <div class="flex gap-2 overflow-x-auto scrollbar-hide">
      <button type="button" data-tab-target="iuran" class="tab-button whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full bg-indigo-600 text-white">Iuran Warga</button>
      <button type="button" data-tab-target="pemasukan" class="tab-button whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full text-gray-700 hover:bg-gray-100">Pemasukan</button>
      <button type="button" data-tab-target="pengeluaran" class="tab-button whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full text-gray-700 hover:bg-gray-100">Pengeluaran</button>
      <button type="button" data-tab-target="ringkasan" class="tab-button whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full text-gray-700 hover:bg-gray-100">Ringkasan</button>
    </div>
  </div>

  <div data-tab-panel="iuran" class="tab-panel">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
      <% if @rows.any? %>
        <div class="space-y-3 p-4 sm:hidden">
          <% @rows.each do |row| %>
            <div class="rounded-xl border border-gray-200 p-4 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold text-gray-900"><%= row[:address_label] %></div>
                  <div class="text-xs text-gray-500"><%= row[:owner] %></div>
                </div>
                <div class="text-right">
                  <div class="text-[11px] text-gray-500 uppercase tracking-wider">Total</div>
                  <div class="text-sm font-semibold text-gray-900">
                    <% if row[:total].positive? %>
                      <%= number_to_currency(row[:total], unit: 'Rp ', precision: 0, delimiter: '.') %>
                    <% else %>
                      -
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
                <div>
                  <div class="text-gray-500">Bayar Bulan</div>
                  <div class="text-gray-900 font-medium"><%= row[:months_paid].presence || '-' %></div>
                </div>
                <div>
                  <div class="text-gray-500">Payment Type</div>
                  <div class="text-gray-900 font-medium"><%= row[:payment_types].presence || '-' %></div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <div class="hidden sm:block overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Alamat</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Pemilik</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Bayar Bulan</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment Type</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Total Bayar</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              <% @rows.each do |row| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-900"><%= row[:address_label] %></td>
                  <td class="px-4 py-3 text-sm text-gray-700"><%= row[:owner] %></td>
                  <td class="px-4 py-3 text-sm text-gray-700"><%= row[:months_paid].presence || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-700"><%= row[:payment_types].presence || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                    <% if row[:total].positive? %>
                      <%= number_to_currency(row[:total], unit: 'Rp ', precision: 0, delimiter: '.') %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-4 text-sm text-gray-600">Tidak ada data untuk filter yang dipilih.</div>
      <% end %>
    </div>
  </div>

  <div data-tab-panel="pemasukan" class="tab-panel hidden">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100">
        <div class="text-sm font-semibold text-gray-900">Detail Pemasukan Lain</div>
        <div class="text-xs text-gray-500">Transaksi debit selain Iuran Warga.</div>
      </div>
      <% if @income_items.any? %>
        <div class="space-y-3 p-4 sm:hidden">
          <% @income_items.each do |item| %>
            <div class="rounded-xl border border-gray-200 p-4 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold text-gray-900"><%= item.description.presence || '-' %></div>
                  <div class="text-xs text-gray-500"><%= item.transaction_date&.strftime('%d %B %Y') || '-' %></div>
                </div>
                <div class="text-right">
                  <div class="text-[11px] text-gray-500 uppercase tracking-wider">Nominal</div>
                  <div class="text-sm font-semibold text-gray-900"><%= number_to_currency(item.total.to_f, unit: 'Rp ', precision: 0, delimiter: '.') %></div>
                </div>
              </div>
              <div class="mt-3 text-xs">
                <div class="text-gray-500">Kategori</div>
                <div class="text-gray-900 font-medium"><%= CashTransaction::GROUP.invert[item.transaction_group] || '-' %></div>
              </div>
            </div>
          <% end %>
        </div>

        <div class="hidden sm:block overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tanggal</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Deskripsi</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kategori</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Nominal</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              <% @income_items.each do |item| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-700"><%= item.transaction_date&.strftime('%d %B %Y') || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-900"><%= item.description.presence || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-700"><%= CashTransaction::GROUP.invert[item.transaction_group] || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                    <%= number_to_currency(item.total.to_f, unit: 'Rp ', precision: 0, delimiter: '.') %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-4 text-sm text-gray-600">Tidak ada data pemasukan untuk filter yang dipilih.</div>
      <% end %>
    </div>
  </div>

  <div data-tab-panel="pengeluaran" class="tab-panel hidden">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="px-4 py-3 border-b border-gray-100">
        <div class="text-sm font-semibold text-gray-900">Detail Pengeluaran</div>
        <div class="text-xs text-gray-500">Berdasarkan tanggal transaksi kas.</div>
      </div>
      <% if @expense_items.any? %>
        <div class="space-y-3 p-4 sm:hidden">
          <% @expense_items.each do |item| %>
            <div class="rounded-xl border border-gray-200 p-4 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-sm font-semibold text-gray-900"><%= item.description.presence || '-' %></div>
                  <div class="text-xs text-gray-500"><%= item.transaction_date&.strftime('%d %B %Y') || '-' %></div>
                </div>
                <div class="text-right">
                  <div class="text-[11px] text-gray-500 uppercase tracking-wider">Nominal</div>
                  <div class="text-sm font-semibold text-gray-900"><%= number_to_currency(item.total.to_f, unit: 'Rp ', precision: 0, delimiter: '.') %></div>
                </div>
              </div>
              <div class="mt-3 text-xs">
                <div class="text-gray-500">Kategori</div>
                <div class="text-gray-900 font-medium"><%= CashTransaction::GROUP.invert[item.transaction_group] || '-' %></div>
              </div>
            </div>
          <% end %>
        </div>

        <div class="hidden sm:block overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tanggal</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Deskripsi</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kategori</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Nominal</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              <% @expense_items.each do |item| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-700"><%= item.transaction_date&.strftime('%d %B %Y') || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-900"><%= item.description.presence || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-700"><%= CashTransaction::GROUP.invert[item.transaction_group] || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                    <%= number_to_currency(item.total.to_f, unit: 'Rp ', precision: 0, delimiter: '.') %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-4 text-sm text-gray-600">Tidak ada data pengeluaran untuk filter yang dipilih.</div>
      <% end %>
    </div>
  </div>

  <div data-tab-panel="ringkasan" class="tab-panel hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <% @totals_by_block.sort.each do |block, totals| %>
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-4 space-y-2">
          <div class="text-sm font-semibold text-gray-900">Blok <%= block %></div>
          <div class="flex justify-between text-sm text-gray-700"><span>Cash</span><strong><%= number_to_currency(totals[:cash], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
          <div class="flex justify-between text-sm text-gray-700"><span>Transfer</span><strong><%= number_to_currency(totals[:transfer], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
          <div class="flex justify-between text-sm text-gray-700"><span>QRIS</span><strong><%= number_to_currency(totals[:qris], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
          <div class="flex justify-between text-sm text-gray-900 border-t border-gray-100 pt-2"><span>Total Blok</span><strong><%= number_to_currency(totals[:total], unit: 'Rp ', precision: 0, delimiter: '.') %></strong></div>
        </div>
      <% end %>
    </div>
  </div>

  <script>
    (function () {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      const panels = Array.from(document.querySelectorAll('.tab-panel'));
      if (!buttons.length || !panels.length) return;

      const setActive = (target) => {
        buttons.forEach((button) => {
          const isActive = button.dataset.tabTarget === target;
          button.classList.toggle('bg-indigo-600', isActive);
          button.classList.toggle('text-white', isActive);
          button.classList.toggle('text-gray-700', !isActive);
        });
        panels.forEach((panel) => {
          panel.classList.toggle('hidden', panel.dataset.tabPanel !== target);
        });
      };

      buttons.forEach((button) => {
        button.addEventListener('click', () => setActive(button.dataset.tabTarget));
      });
    })();
  </script>
</div>
